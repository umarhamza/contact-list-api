'use strict';

(function () {
    // Get input element
    var filterInput = document.getElementById('filter-input');
    // Get the ul list of all names
    var list = document.querySelector('#names');
    // Retrieve data from local storage
    var storedData = JSON.parse(localStorage.getItem('names'));

    // Initiate all functions 
    var initAll = function initAll() {
        CheckData();
        Input();
    }; // initAll

    var CheckData = function CheckData() {
        if (storedData) {
            CreateList(storedData);
        } else {
            LoadData();
        }
    }; // CheckData

    var LoadData = function LoadData() {
        var request = new XMLHttpRequest();
        request.open('GET', 'http://uinames.com/api/?amount=25?region=united-kingdom', true);

        request.onload = function () {
            if (this.status >= 200 && this.status < 400) {
                var data = JSON.parse(this.response);
                StoreData(data);
                CreateList(data);
            } else {
                console.error('server returned an error');
            }
        };

        request.onerror = function () {
            console.error('There was a connection error of some sort');
        };

        request.send();
    }; // LoadData

    var StoreData = function StoreData(loadedData) {
        localStorage.setItem('names', JSON.stringify(loadedData));
    }; // StoreData

    var Input = function Input() {
        // Add keyup event listener on input
        filterInput.addEventListener('keyup', filterNames);

        function filterNames(e) {
            // Get value inside input
            var filterValue = this.value.toUpperCase();
            // Get the li list item
            var listItem = list.querySelectorAll('li.collection-item');

            // loop through collection item li's
            listItem.forEach(function (item) {
                // Get the anchor inside each item
                var anchor = item.querySelector('a');
                // Get anchor text
                var anchorText = anchor.innerHTML.toUpperCase();

                if (anchorText.indexOf(filterValue) > -1) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }
    }; // Input

    var CreateList = function CreateList(data) {
        var names = data.map(function (item) {
            return item.name;
        }).sort();

        var items = '';
        var firstLetter = '';

        names.forEach(function (name, i, arr) {
            if (firstLetter === name[0]) {
                items += '\n                    <li class="collection-item">\n                        <a href="#">' + name + '</a>\n                    </li>\n                ';
            } else {
                console.log(firstLetter, firstLetter !== undefined, name);
                if (firstLetter !== undefined) {
                    firstLetter = name[0];
                    items += '\n                        <li class="collection-header"><h5>' + firstLetter + '</h5></li>\n                        <li class="collection-item"><a href="#">' + name + '</a></li>\n                    ';
                }
            }

            list.innerHTML = items;
        });
    }; // CreateList

    document.addEventListener('DOMContentLoaded', initAll);
})();